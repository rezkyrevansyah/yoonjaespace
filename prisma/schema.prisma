generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model User {
  id              String        @id
  name            String
  email           String        @unique
  role            Role          @default(ADMIN)
  isActive        Boolean       @default(true)
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt
  phone           String?
  customRoleId    String?
  activities      ActivityLog[]
  handledBookings Booking[]     @relation("HandledBy")
  commissions     Commission[]
  customRole      CustomRole?   @relation(fields: [customRoleId], references: [id])

  @@index([role])
  @@index([customRoleId], map: "users_custom_role_id_idx")
  @@index([email])
  @@index([isActive], map: "users_is_active_idx")
  @@map("users")
}

model Client {
  id        String    @id @default(cuid())
  name      String
  phone     String
  email     String?
  address   String?
  notes     String?
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  instagram String?
  domisili  String?
  leads     String?
  bookings  Booking[]

  @@index([phone])
  @@index([name])
  @@index([email])
  @@map("clients")
}

model Package {
  id              String    @id @default(cuid())
  name            String
  description     String?
  price           Float
  duration        Int
  maxPeople       Int       @default(1)
  isActive        Boolean   @default(true)
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  allPhotos       Boolean   @default(false)
  editedPhotos    Int       @default(0)
  extraTimeBefore Int       @default(0)
  bookings        Booking[]

  @@map("packages")
}

model Background {
  id                 String              @id @default(cuid())
  name               String
  isActive           Boolean             @default(true)
  createdAt          DateTime            @default(now())
  description        String?
  bookingBackgrounds BookingBackground[]

  @@map("backgrounds")
}

model Booking {
  id                 String               @id @default(cuid())
  bookingCode        String               @unique
  publicSlug         String               @unique
  clientId           String
  date               DateTime
  startTime          DateTime
  endTime            DateTime
  packageId          String
  numberOfPeople     Int                  @default(1)
  photoFor           PhotoFor             @default(OTHER)
  bts                Boolean              @default(false)
  status             BookingStatus        @default(BOOKED)
  paymentStatus      PaymentStatus        @default(UNPAID)
  packagePrice       Float
  discountAmount     Float                @default(0)
  discountNote       String?
  totalAmount        Float
  photoLink          String?
  deliveredAt        DateTime?
  notes              String?
  internalNotes      String?
  handledById        String
  createdAt          DateTime             @default(now())
  updatedAt          DateTime             @updatedAt
  paidAt             DateTime?
  paymentProof       String?
  remindedAt         DateTime?
  muaStartTime       DateTime?
  addOns             BookingAddOn[]
  bookingBackgrounds BookingBackground[]
  customFields       BookingCustomField[]
  history            BookingHistory[]
  client             Client               @relation(fields: [clientId], references: [id])
  handledBy          User                 @relation("HandledBy", fields: [handledById], references: [id])
  package            Package              @relation(fields: [packageId], references: [id])
  expenses           Expense[]
  invoice            Invoice?
  printOrder         PrintOrder?

  @@index([date])
  @@index([status])
  @@index([date, status])
  @@index([bookingCode], map: "bookings_booking_code_idx")
  @@index([clientId], map: "bookings_client_id_idx")
  @@index([handledById], map: "bookings_handled_by_id_idx")
  @@map("bookings")
}

model BookingBackground {
  id           String     @id @default(cuid())
  bookingId    String
  backgroundId String
  background   Background @relation(fields: [backgroundId], references: [id])
  booking      Booking    @relation(fields: [bookingId], references: [id], onDelete: Cascade)

  @@unique([bookingId, backgroundId])
  @@map("booking_backgrounds")
}

model AddOnTemplate {
  id              String   @id @default(cuid())
  name            String
  defaultPrice    Float
  isActive        Boolean  @default(true)
  createdAt       DateTime @default(now())
  extraTimeBefore Int      @default(0)

  @@map("addon_templates")
}

model BookingAddOn {
  id        String   @id @default(cuid())
  bookingId String
  itemName  String
  quantity  Int      @default(1)
  unitPrice Float
  subtotal  Float
  createdAt DateTime @default(now())
  booking   Booking  @relation(fields: [bookingId], references: [id], onDelete: Cascade)

  @@map("booking_addons")
}

model PrintOrder {
  id              String      @id @default(cuid())
  bookingId       String      @unique
  status          PrintStatus @default(WAITING_CLIENT_SELECTION)
  selectedPhotos  String?
  vendorName      String?
  vendorNotes     String?
  shippingAddress String?
  courier         String?
  trackingNumber  String?
  shippedAt       DateTime?
  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt
  booking         Booking     @relation(fields: [bookingId], references: [id], onDelete: Cascade)

  @@index([status])
  @@index([bookingId], map: "print_orders_booking_id_idx")
  @@map("print_orders")
}

model Invoice {
  id            String   @id @default(cuid())
  bookingId     String   @unique
  invoiceNumber String   @unique
  issuedAt      DateTime @default(now())
  pdfUrl        String?
  booking       Booking  @relation(fields: [bookingId], references: [id], onDelete: Cascade)

  @@map("invoices")
}

model CustomFieldDefinition {
  id         String               @id @default(cuid())
  fieldName  String
  fieldType  String               @default("text")
  options    String?
  isRequired Boolean              @default(false)
  isActive   Boolean              @default(true)
  sortOrder  Int                  @default(0)
  createdAt  DateTime             @default(now())
  values     BookingCustomField[]

  @@map("custom_field_definitions")
}

model BookingCustomField {
  id        String                @id @default(cuid())
  bookingId String
  fieldId   String
  value     String
  booking   Booking               @relation(fields: [bookingId], references: [id], onDelete: Cascade)
  field     CustomFieldDefinition @relation(fields: [fieldId], references: [id])

  @@unique([bookingId, fieldId])
  @@map("booking_custom_fields")
}

model Vendor {
  id        String    @id @default(cuid())
  name      String
  category  String
  phone     String?
  email     String?
  address   String?
  notes     String?
  isActive  Boolean   @default(true)
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  expenses  Expense[]

  @@index([category])
  @@index([isActive])
  @@map("vendors")
}

model Expense {
  id               String          @id @default(cuid())
  description      String
  amount           Float
  category         ExpenseCategory
  date             DateTime
  relatedBookingId String?
  notes            String?
  vendorId         String?
  vendorPaid       Boolean         @default(false)
  createdAt        DateTime        @default(now())
  updatedAt        DateTime        @updatedAt
  relatedBooking   Booking?        @relation(fields: [relatedBookingId], references: [id])
  vendor           Vendor?         @relation(fields: [vendorId], references: [id], onDelete: SetNull)

  @@index([date])
  @@index([category])
  @@index([vendorId])
  @@map("expenses")
}

model BookingHistory {
  id        String   @id @default(cuid())
  bookingId String
  action    String
  field     String?
  oldValue  String?
  newValue  String?
  changedBy String
  createdAt DateTime @default(now())
  booking   Booking  @relation(fields: [bookingId], references: [id], onDelete: Cascade)

  @@map("booking_history")
}

model Commission {
  id            String    @id @default(cuid())
  userId        String
  month         Int
  year          Int
  totalBookings Int
  amount        Float
  notes         String?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  paidAt        DateTime?
  user          User      @relation(fields: [userId], references: [id])

  @@unique([userId, month, year])
  @@index([month, year])
  @@index([userId], map: "commissions_user_id_idx")
  @@index([userId, month, year], map: "commissions_user_month_year_idx")
  @@map("commissions")
}

model Voucher {
  id            String    @id @default(cuid())
  code          String    @unique
  description   String?
  discountType  String    @default("fixed")
  discountValue Float
  minPurchase   Float?
  maxUsage      Int?
  usedCount     Int       @default(0)
  isActive      Boolean   @default(true)
  validFrom     DateTime?
  validUntil    DateTime?
  createdAt     DateTime  @default(now())

  @@map("vouchers")
}

model StudioSetting {
  id        String   @id @default(cuid())
  key       String   @unique
  value     String
  updatedAt DateTime @updatedAt

  @@map("studio_settings")
}

model ActivityLog {
  id        String   @id @default(cuid())
  userId    String
  action    String
  details   String?
  type      String   @default("SYSTEM")
  timestamp DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id])

  @@index([timestamp(sort: Desc)])
  @@index([type])
  @@index([userId], map: "activity_logs_user_id_idx")
  @@map("activity_logs")
}

model CustomRole {
  id          String           @id @default(cuid())
  name        String           @unique
  description String?
  isSystem    Boolean          @default(false)
  createdAt   DateTime         @default(now())
  updatedAt   DateTime         @updatedAt
  permissions RolePermission[]
  users       User[]

  @@map("custom_roles")
}

model Menu {
  id          String           @id @default(cuid())
  name        String           @unique
  label       String
  sortOrder   Int              @default(0)
  createdAt   DateTime         @default(now())
  permissions RolePermission[]

  @@map("menus")
}

model RolePermission {
  id        String     @id @default(cuid())
  roleId    String
  menuId    String
  canView   Boolean    @default(true)
  canEdit   Boolean    @default(false)
  canDelete Boolean    @default(false)
  menu      Menu       @relation(fields: [menuId], references: [id], onDelete: Cascade)
  role      CustomRole @relation(fields: [roleId], references: [id], onDelete: Cascade)

  @@unique([roleId, menuId])
  @@index([menuId], map: "role_permissions_menu_id_idx")
  @@index([roleId], map: "role_permissions_role_id_idx")
  @@map("role_permissions")
}

enum Role {
  OWNER
  ADMIN
  PHOTOGRAPHER
  PACKAGING_STAFF
}

enum BookingStatus {
  BOOKED
  PAID
  SHOOT_DONE
  PHOTOS_DELIVERED
  CLOSED
  CANCELLED
}

enum PaymentStatus {
  UNPAID
  PAID
  PARTIALLY_PAID
}

enum PhotoFor {
  BIRTHDAY
  GRADUATION
  FAMILY
  GROUP
  LINKEDIN
  PAS_PHOTO
  STUDIO_ONLY
  OTHER
}

enum PrintStatus {
  WAITING_CLIENT_SELECTION
  SENT_TO_VENDOR
  PRINTING_IN_PROGRESS
  PRINT_RECEIVED
  PACKAGING
  SHIPPED
  COMPLETED
}

enum ExpenseCategory {
  PRINT_VENDOR
  PACKAGING
  SHIPPING
  OPERATIONAL
  OTHER
  EQUIPMENT
  STUDIO_RENT
  PROPS
  UTILITIES
  MARKETING
  SALARY
}
